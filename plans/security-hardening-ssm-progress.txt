# Progress Log
PRD: plans/security-hardening-ssm.prd.json
Started: 2025-01-13

## Context
Security hardening for Treasury Home Hugo site Terraform infrastructure.
Based on security review findings from security-sentinel and iac-security-hardener agents.

## Key Decisions
- Log retention: 90 days (staging environment)
- WAF: Include now with managed rules
- SSM validation: Pre-deploy script (validate-config.sh)
- CSP: Permissive (allow unsafe-inline for styles)
- TLS: Enforce 1.2+ minimum

## Reference Files
- Existing Terraform: /Users/CorcosS/code/home.treasury.gov/terraform/
- Ship SSM patterns: /Users/CorcosS/code/ship/scripts/sync-terraform-config.sh
- Ship validation: /Users/CorcosS/code/ship/api/src/config/ssm.ts

---

## Iteration 1 - Add S3 server-side encryption
- Completed: Added aws_s3_bucket_server_side_encryption_configuration.site with AES256 algorithm and bucket_key_enabled
- Files changed: terraform/main.tf
- Learnings: Encryption config is a separate resource in AWS provider v4+
- Next: Story 2 - Create logging bucket with S3/CloudFront logging

## Iteration 2 - Create logging bucket with S3/CloudFront logging
- Completed: Added dedicated logging bucket with full security configuration
- Resources added:
  - aws_s3_bucket.logs
  - aws_s3_bucket_public_access_block.logs
  - aws_s3_bucket_server_side_encryption_configuration.logs
  - aws_s3_bucket_ownership_controls.logs (BucketOwnerPreferred for CloudFront)
  - aws_s3_bucket_lifecycle_configuration.logs (90-day expiration)
  - aws_s3_bucket_logging.site (S3 access logging)
  - logging_config block in CloudFront distribution
- Files changed: terraform/main.tf
- Learnings: Lifecycle rules require explicit `filter {}` block in AWS provider v4+
- Next: Story 3 - Add CloudFront security headers policy

## Iteration 3 - Add CloudFront security headers policy
- Completed: Created response headers policy with comprehensive security headers
- Headers configured:
  - HSTS (max-age 1 year, includeSubdomains, preload)
  - X-Frame-Options: DENY
  - X-Content-Type-Options: nosniff
  - Referrer-Policy: strict-origin-when-cross-origin
  - XSS-Protection: 1; mode=block
  - CSP: permissive mode with 'unsafe-inline' for styles
- Policy attached to all 4 cache behaviors (default, images, CSS, JS)
- Files changed: terraform/main.tf
- Learnings: CloudFront response headers policy is separate from cache behavior config
- Next: Story 4 - Add AWS WAF with managed rules

## Iteration 4 - Add AWS WAF with managed rules
- Completed: Created WAF WebACL with managed rules and rate limiting
- Resources added:
  - aws_wafv2_web_acl.cloudfront (scope CLOUDFRONT, us-east-1 provider)
  - AWSManagedRulesCommonRuleSet (priority 1)
  - AWSManagedRulesKnownBadInputsRuleSet (priority 2)
  - RateLimitRule (2000 req/5min, priority 3)
- Added us-east-1 provider alias for WAF (CloudFront WAF requirement)
- Attached WAF to CloudFront via web_acl_id
- Files changed: terraform/provider.tf, terraform/main.tf
- Learnings: WAF for CloudFront must be in us-east-1, requires provider alias
- Next: Story 5 - Create SSM parameters for infrastructure IDs
