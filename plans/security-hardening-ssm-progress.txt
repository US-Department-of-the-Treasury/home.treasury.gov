# Progress Log
PRD: plans/security-hardening-ssm.prd.json
Started: 2025-01-13

## Context
Security hardening for Treasury Home Hugo site Terraform infrastructure.
Based on security review findings from security-sentinel and iac-security-hardener agents.

## Key Decisions
- Log retention: 90 days (staging environment)
- WAF: Include now with managed rules
- SSM validation: Pre-deploy script (validate-config.sh)
- CSP: Permissive (allow unsafe-inline for styles)
- TLS: Enforce 1.2+ minimum

## Reference Files
- Existing Terraform: /Users/CorcosS/code/home.treasury.gov/terraform/
- Ship SSM patterns: /Users/CorcosS/code/ship/scripts/sync-terraform-config.sh
- Ship validation: /Users/CorcosS/code/ship/api/src/config/ssm.ts

---

## Iteration 1 - Add S3 server-side encryption
- Completed: Added aws_s3_bucket_server_side_encryption_configuration.site with AES256 algorithm and bucket_key_enabled
- Files changed: terraform/main.tf
- Learnings: Encryption config is a separate resource in AWS provider v4+
- Next: Story 2 - Create logging bucket with S3/CloudFront logging

## Iteration 2 - Create logging bucket with S3/CloudFront logging
- Completed: Added dedicated logging bucket with full security configuration
- Resources added:
  - aws_s3_bucket.logs
  - aws_s3_bucket_public_access_block.logs
  - aws_s3_bucket_server_side_encryption_configuration.logs
  - aws_s3_bucket_ownership_controls.logs (BucketOwnerPreferred for CloudFront)
  - aws_s3_bucket_lifecycle_configuration.logs (90-day expiration)
  - aws_s3_bucket_logging.site (S3 access logging)
  - logging_config block in CloudFront distribution
- Files changed: terraform/main.tf
- Learnings: Lifecycle rules require explicit `filter {}` block in AWS provider v4+
- Next: Story 3 - Add CloudFront security headers policy

## Iteration 3 - Add CloudFront security headers policy
- Completed: Created response headers policy with comprehensive security headers
- Headers configured:
  - HSTS (max-age 1 year, includeSubdomains, preload)
  - X-Frame-Options: DENY
  - X-Content-Type-Options: nosniff
  - Referrer-Policy: strict-origin-when-cross-origin
  - XSS-Protection: 1; mode=block
  - CSP: permissive mode with 'unsafe-inline' for styles
- Policy attached to all 4 cache behaviors (default, images, CSS, JS)
- Files changed: terraform/main.tf
- Learnings: CloudFront response headers policy is separate from cache behavior config
- Next: Story 4 - Add AWS WAF with managed rules

## Iteration 4 - Add AWS WAF with managed rules
- Completed: Created WAF WebACL with managed rules and rate limiting
- Resources added:
  - aws_wafv2_web_acl.cloudfront (scope CLOUDFRONT, us-east-1 provider)
  - AWSManagedRulesCommonRuleSet (priority 1)
  - AWSManagedRulesKnownBadInputsRuleSet (priority 2)
  - RateLimitRule (2000 req/5min, priority 3)
- Added us-east-1 provider alias for WAF (CloudFront WAF requirement)
- Attached WAF to CloudFront via web_acl_id
- Files changed: terraform/provider.tf, terraform/main.tf
- Learnings: WAF for CloudFront must be in us-east-1, requires provider alias
- Next: Story 5 - Create SSM parameters for infrastructure IDs

## Iteration 5 - Create SSM parameters for infrastructure IDs
- Completed: Added SSM parameters for all infrastructure outputs
- Parameters created (path: /{project_name}/{environment}/{PARAM}):
  - S3_BUCKET_NAME
  - CLOUDFRONT_DISTRIBUTION_ID
  - CLOUDFRONT_DOMAIN
  - SITE_URL
- All parameters reference actual Terraform resource values
- Files changed: terraform/main.tf
- Learnings: SSM parameters should match outputs for deploy script consumption
- Next: Story 6 - Create pre-deploy validation script

## Iteration 6 - Create pre-deploy validation script
- Completed: Created deploy/validate-config.sh with fail-fast SSM validation
- Features:
  - Checks all 4 required SSM parameters before deployment
  - Exits 1 with detailed error message if any parameter missing
  - Shows how to fix: terraform apply or manual aws ssm put-parameter
  - Displays found configuration values when successful
  - Accepts environment as optional argument (defaults to staging)
- Files changed: deploy/validate-config.sh (new)
- Learnings: Fail-fast validation prevents wild goose chases on missing infra
- Next: Story 7 - Enforce TLS 1.2+ and migrate to cache policies

## Iteration 7 - Enforce TLS 1.2+ and migrate to cache policies
- Completed: Upgraded TLS and migrated to managed cache policies
- Changes:
  - Set minimum_protocol_version to TLSv1.2_2021 in viewer_certificate
  - Removed all deprecated forwarded_values blocks
  - Default/images use AWS managed CachingOptimized policy
  - CSS/JS use custom immutable_assets cache policy (1-year TTL)
- Resources added:
  - data.aws_cloudfront_cache_policy.caching_optimized
  - aws_cloudfront_cache_policy.immutable_assets
- Files changed: terraform/main.tf
- Learnings: Custom cache policies needed for immutable assets with max TTL
- Next: Story 8 - Add S3 lifecycle rules for site bucket versioning

## Iteration 8 - Add S3 lifecycle rules for site bucket versioning
- Completed: Added lifecycle configuration for site bucket
- Rules configured:
  - expire-old-versions: Delete noncurrent versions after 30 days
  - abort-incomplete-uploads: Abort incomplete multipart uploads after 7 days
- Files changed: terraform/main.tf
- Learnings: Lifecycle rules need explicit `filter {}` block in AWS provider v4+

---

## PRD COMPLETE

All 8 user stories have been implemented and verified:
1. S3 server-side encryption (AES256)
2. Logging bucket with S3/CloudFront access logging
3. CloudFront security headers policy
4. AWS WAF with managed rules
5. SSM parameters for infrastructure IDs
6. Pre-deploy validation script
7. TLS 1.2+ enforcement and managed cache policies
8. S3 lifecycle rules for site bucket

Total commits: 8
Files changed: terraform/main.tf, terraform/provider.tf, deploy/validate-config.sh
